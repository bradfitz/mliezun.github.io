<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Reinventing the Wheel: PHP Generators | mliezun.github.io</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Reinventing the Wheel: PHP Generators" />
<meta name="author" content="Miguel Liezun" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Attempt of a lunatic to recreate functionalities that a language already has using the same language, and failing." />
<meta property="og:description" content="Attempt of a lunatic to recreate functionalities that a language already has using the same language, and failing." />
<meta property="og:site_name" content="mliezun.github.io" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-01-24T00:00:00-03:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","author":{"@type":"Person","name":"Miguel Liezun"},"headline":"Reinventing the Wheel: PHP Generators","dateModified":"2020-01-24T00:00:00-03:00","datePublished":"2020-01-24T00:00:00-03:00","description":"Attempt of a lunatic to recreate functionalities that a language already has using the same language, and failing.","url":"/2020/01/24/php-generator.html","mainEntityOfPage":{"@type":"WebPage","@id":"/2020/01/24/php-generator.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=5aa86330cea44de0a2bf6f1b8652bbe6ec6e78ce">
    <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="/">mliezun.github.io</a></h1>
        
        

        <p></p>

        
        <p class="view"><a href="https://github.com/mliezun/mliezun.github.io">View the Project on GitHub <small>mliezun/mliezun.github.io</small></a></p>
        

        

        
      </header>
      <section>

      <small>24 January 2020</small>
<h1>Reinventing the Wheel: PHP Generators</h1>

<p class="view">by Miguel Liezun</p>

<h2 id="first-thing-first-how-a-generator-works">First thing first. How a generator works?</h2>

<h3 id="starting-back-at-c">Starting back at C</h3>

<p>Let’s create a function that each time we call it we get the next number of the fibonacci sequence.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">fibonacci</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">aux</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">aux</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If we call fibonacci(), the first time we’ll get 1, the second time 1, the third 2, the fourth 3, and so on…</p>

<p>This happens because we declared variables <code class="language-plaintext highlighter-rouge">a, b</code> to be static. This means that they mantain the value after the function returns. Normally, what happens (if we don’t declare a variable as static) is that the variables inside the function don’t mantain the values of the last execution.</p>

<h3 id="first-generator-for-php">First generator for PHP</h3>

<p>The equivalent function in PHP is pretty similar to C’s approach.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">fibonacci</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">static</span> <span class="nv">$b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nv">$aux</span> <span class="o">=</span> <span class="nv">$b</span><span class="p">;</span>
    <span class="nv">$b</span> <span class="o">=</span> <span class="nv">$a</span> <span class="o">+</span> <span class="nv">$b</span><span class="p">;</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$aux</span><span class="p">;</span>
    <span class="k">return</span> <span class="nv">$a</span><span class="p">;</span>
<span class="p">}</span>

<span class="nv">$out</span> <span class="o">=</span> <span class="p">[];</span>

<span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$out</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">fibonacci</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">', '</span><span class="p">,</span> <span class="nv">$out</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="cm">/*
Output: 1, 1, 2, 3, 5, 8, 13, 21, 34, 55
*/</span>
</code></pre></div></div>

<p>Let’s compare this to the <code class="language-plaintext highlighter-rouge">real</code> PHP version using <code class="language-plaintext highlighter-rouge">yield</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">function</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="nv">$N</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nv">$b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$N</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$aux</span> <span class="o">=</span> <span class="nv">$b</span><span class="p">;</span>
        <span class="nv">$b</span> <span class="o">=</span> <span class="nv">$a</span> <span class="o">+</span> <span class="nv">$b</span><span class="p">;</span>
        <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$aux</span><span class="p">;</span>
        <span class="k">yield</span> <span class="nv">$a</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$out</span> <span class="o">=</span> <span class="p">[];</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nx">fibonacci</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$fib</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$out</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$fib</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">', '</span><span class="p">,</span> <span class="nv">$out</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>

<span class="cm">/*
Output: 1, 1, 2, 3, 5, 8, 13, 21, 34, 55
*/</span>
</code></pre></div></div>

<h3 id="creating-a-custom-version-of-php-yield">Creating a custom version of PHP <code class="language-plaintext highlighter-rouge">yield</code></h3>

<p>This is my own version using the library parallel and channels (probably uses yield internally).</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="kd">class</span> <span class="nc">MyGenerator</span> <span class="k">implements</span> <span class="nx">Iterator</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$chan</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$current</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$iteratorFn</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$runtime</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$key</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$valid</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$iteratorFn</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">iteratorFn</span> <span class="o">=</span> <span class="nv">$iteratorFn</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">runtime</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\parallel\Runtime</span><span class="p">();</span>
        <span class="nv">$channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\parallel\Channel</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">runtime</span><span class="o">-&gt;</span><span class="na">run</span><span class="p">(</span><span class="k">function</span><span class="p">()</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$iteratorFn</span><span class="p">,</span> <span class="nv">$channel</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$iteratorFn</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$val</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$channel</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$channel</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$val</span><span class="p">);</span>
            <span class="p">});</span>
            <span class="nv">$channel</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
        <span class="p">});</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">chan</span> <span class="o">=</span> <span class="nv">$channel</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">next</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">current</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">current</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">next</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="o">++</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">;</span>
            <span class="nv">$val</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">chan</span><span class="o">-&gt;</span><span class="na">recv</span><span class="p">();</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">current</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\parallel\Channel\Error\Closed</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">valid</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">current</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">key</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">;}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">valid</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">valid</span><span class="p">;}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">rewind</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>


<span class="k">function</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="nv">$N</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">MyGenerator</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$yield</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$N</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="nv">$N</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$aux</span> <span class="o">=</span> <span class="nv">$b</span><span class="p">;</span>
            <span class="nv">$b</span> <span class="o">=</span> <span class="nv">$a</span> <span class="o">+</span> <span class="nv">$b</span><span class="p">;</span>
            <span class="nv">$a</span> <span class="o">=</span> <span class="nv">$aux</span><span class="p">;</span>
            <span class="nv">$yield</span><span class="p">(</span><span class="nv">$a</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="nv">$out</span> <span class="o">=</span> <span class="p">[];</span>

<span class="k">foreach</span> <span class="p">(</span><span class="nx">fibonacci</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$fib</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$out</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$fib</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">echo</span> <span class="nb">implode</span><span class="p">(</span><span class="s1">', '</span><span class="p">,</span> <span class="nv">$out</span><span class="p">)</span> <span class="o">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="performance-comparison-php-vs-custom">Performance comparison: PHP vs Custom</h3>

<h4 id="tested-code">Tested code</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="nv">$i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="o">++</span><span class="nv">$i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nx">fibonacci</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$fib</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$out</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$fib</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="yield-version"><code class="language-plaintext highlighter-rouge">yield</code> version</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>real    0m0,083s
user    0m0,059s
sys     0m0,023s
</code></pre></div></div>

<h4 id="mygenerator-version"><code class="language-plaintext highlighter-rouge">MyGenerator</code> version</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>real    0m2,138s
user    0m1,426s
sys     0m1,363s
</code></pre></div></div>

<p>So, it’s aproximately 26 times slower :-)</p>



  <small>tags: <em>php,</em> - <em>generators</em></small>



      </section>
      <footer>
        
        <p>This project is maintained by <a href="https://github.com/mliezun">mliezun</a></p>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="/assets/js/scale.fix.js"></script>
    
  </body>
</html>
